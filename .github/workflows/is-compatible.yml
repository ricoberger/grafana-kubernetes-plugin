name: Latest Grafana API Compatibility Check

on:
  pull_request:

jobs:
  compatibilitycheck:
    name: Compatibility Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Plugin
        run: npm run build

      # - name: Find "module.ts" or "module.tsx"
      #   id: find-module-ts
      #   run: |
      #     MODULETS="$(find ./src -type f \( -name "module.ts" -o -name "module.tsx" \))"
      #     echo "modulets=${MODULETS}" >> $GITHUB_OUTPUT

      - name: Compatibility Check
        uses: grafana/plugin-actions/is-compatible@main
        with:
          # module: ${{ steps.find-module-ts.outputs.modulets }}
          module: ./src/module.tsx
          comment-pr: 'no'
          fail-if-incompatible: 'yes'
